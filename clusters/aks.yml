# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#
version: '3'

tasks:
  login: |-
    AZ_IS_LOGGED=$(az account list)    
    if [ "${AZ_IS_LOGGED}" != "[]" ]
    then
      echo "Already logged in!"
    else
      az login --service-principal -u ${AKS_SERVICE_PRINCIPAL_APPID} -p ${AKS_SERVICE_PRINCIPAL_PASSWORD} \
        --tenant ${AKS_SERVICE_PRINCIPAL_TENANT}    
    fi  

  create: 
    deps: 
      - login
    cmds: 
      - |-
        az group create --name nuvolaris --location northeurope
        az aks create \
          --resource-group nuvolaris \
          --name nuvolaris \
          --node-count 1 \
          --node-vm-size Standard_DS3_v2 \
          --node-osdisk-size 80 \
          --node-osdisk-type Ephemeral \
          --nodepool-name nuvnp1 \
          --ssh-key-value id_rsa.pub \
          --network-plugin azure    

  destroy: 
    deps:
      - login
    cmds: 
      - az group delete --name nuvolaris --no-wait --yes
  
  list: 
    deps: 
      - login
    cmds: 
      - az aks list

  config: 
    deps: 
      - login
    cmds: 
      - az aks get-credentials --resource-group nuvolaris --name nuvolaris --file aks.kubeconfig
  
  setingress:
    deps:
      - login
    cmds:
      - |-
        IP=$(kubectl get svc ingress-nginx-controller -n ingress-nginx -o json | jq .status.loadBalancer.ingress[0].ip -r)
        DNSNAME="nuvolaris-ingress"
        PUBLICIPID=$(az network public-ip list --query "[?ipAddress!=null]|[?contains(ipAddress, '$IP')].[id]" --output tsv)
        az network public-ip update --ids $PUBLICIPID --dns-name $DNSNAME
        az network public-ip show --ids $PUBLICIPID --query "[dnsSettings.fqdn]" --output tsv
